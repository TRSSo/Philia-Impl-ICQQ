import icqq from"icqq";import{modeMatch}from"philia/util";export const ExtendArray=[`face`,`sface`,`bface`,`rps`,`dice`,`mirai`,`node`,`forum`,`flash`,`json`,`xml`,`poke`,`location`,`share`,`music`,`long_msg`];export class ICQQtoPhilia{impl;event;before;after=[];summary=``;constructor(e,t){this.impl=e,this.event=t,this.before=t.message}async convert(){for(let e of this.before)typeof e==`object`?typeof this[e.type]==`function`?await this[e.type](e):ExtendArray.includes(e.type)?this.extend(e):this._text(e):this._text(e);return this.event.source&&await this.quote(this.event.source),this}extend(e){this.after.push({type:`extend`,extend:`ICQQ.${e.type}`,data:e}),this.summary+=`[${e.type}: ${e}]`}_text(e,t){let n={type:`text`,data:String(e)};n.data.length&&(t&&(n.markdown=t),this.after.push(n),this.summary+=n.data)}text(e){this._text(e.text)}async at(t){let{qq:n,text:r=``}=t;if(n===`all`){this.summary+=`[提及全体成员]`,this.after.push({type:`mention`,data:`all`});return}let i=String(n);if(!r){let t;this.event instanceof icqq.GroupMessage&&(t=await this.impl.handle.getGroupMemberInfo({id:String(this.event.group_id),uid:i})),t??=await this.impl.handle.getUserInfo({id:i}),t&&(r=t.card||t.name)}this.summary+=`[提及: ${r}(${i})]`,this.after.push({type:`mention`,data:`user`,id:i,name:r})}async file(e){this.after.push({raw:e,type:`file`,id:e.fid,data:`id`,name:e.name}),this.summary+=`[文件: ${e.name}(${e.fid})]`}async image(e){this.after.push({raw:e,type:`image`,id:String(e.fid||e.file),name:e.file,data:`url`,url:e.url}),this.summary+=`[图片: ${e.md5}]`}async record(e){this.after.push({raw:e,type:`voice`,id:String(e.fid||e.file),name:e.file,data:`url`,url:e.url}),this.summary+=`[语音: ${e.md5}]`}async video(e){this.after.push({raw:e,type:`video`,id:String(e.fid||e.file),name:e.file,data:`id`}),this.summary+=`[视频]`}reply(e){this.after.push({type:`reply`,data:e.id,summary:e.text}),this.summary+=`[提及: ${e.text?`${e.text}(${e.id})`:e.id}]`}async quote(t){let n;if(this.event instanceof icqq.GroupMessage)n=(await this.impl.client.pickGroup(this.event.group_id).getChatHistory(t.seq,1))[0]?.message_id;else if(this.event instanceof icqq.PrivateMessage)n=(await this.impl.client.pickFriend(this.event.sender.user_id).getChatHistory(t.time,1))[0]?.message_id;else return;this.after.push({type:`reply`,data:n,summary:t.message}),this.summary+=`[提及: ${t.message?`${t.message}(${n})`:n}]`}markdown(e){this.after.push({raw:e,type:`text`,data:e.content,markdown:e.content}),this.summary+=`[Markdown: ${e.content}]`}_button(e){let t={QQBot:e,text:e.render_data.label,clicked_text:e.render_data.visited_label};switch(e.action.type){case 0:t.link=e.action.data;break;case 1:t.callback=e.action.data;break;case 2:t.input=e.action.data,t.send=e.action.enter;break}return e.action.permission&&(e.action.permission.type===1?t.permission=`admin`:t.permission=e.action.permission.specify_user_ids),t}button(e){let t=e.content.rows.map(e=>e.buttons.map(this._button.bind(this)))||[];this.after.push({raw:e,type:`button`,data:t}),this.summary+=`[按钮]`}}export class PhiliaToICQQ{impl;scene;id;before;after=[];summary=``;file_id;constructor(e,t,n,r){this.impl=e,this.scene=t,this.id=n,this.before=Array.isArray(r)?r:[r]}async convert(){for(let e of this.before)typeof e==`object`&&typeof this[e.type]==`function`?await this[e.type](e):this._text(e);return this}_text(e){e=String(e),e.length&&(this.after.push(e),this.summary+=e)}text(e){this._text(e.data)}mention(e){switch(e.data){case`user`:this.after.push({type:`at`,qq:+e.id,text:e.name}),this.summary+=e.name?`@${e.name}(${e.id})`:`@${e.id}`;break;case`all`:this.after.push({type:`at`,qq:`all`}),this.summary+=`@全体成员`;break}}reply(e){this.after.push({type:`reply`,id:e.data,text:e.summary}),this.summary+=e.summary?`[回复: ${e.summary}(${e.data})]`:`[回复: ${e.data}]`}extend(e){if(!e.extend.startsWith(`ICQQ.`))return;let t=e.extend.replace(`ICQQ.`,``);ExtendArray.includes(t)&&(this.after.push(e.data),this.summary+=`[${e.data.type}: ${e.data}]`)}platform(e){this.summary+=`[${e.list}(${e.mode}) 平台消息: ${e.data}]`,modeMatch(e,`ICQQ`)&&(Array.isArray(e.data)?this.after.push(...e.data):this.after.push(e.data))}async _file(e,t){switch(t.data){case`id`:return this._file(e,await this.impl.handle.getFile({id:t.id}));case`path`:this.after.push({type:e,file:t.path});break;case`binary`:this.after.push({type:e,file:t.binary});break;case`url`:this.after.push({type:e,file:t.url});break}}async file(e){let t=await this.impl.handle._sendFile({scene:this.scene,id:this.id,data:e});this.file_id??=[],this.file_id.push(t),this.summary+=e.summary??`[文件: ${e.name}]`}image(e){this._file(`image`,e),this.summary+=e.summary??`[图片: ${e.name}]`}voice(e){this._file(`record`,e),this.summary+=e.summary??`[语音: ${e.name}]`}async audio(e){await this.impl.handle._sendFile({scene:this.scene,id:this.id,data:e}),this.summary+=e.summary??`[音频: ${e.name}]`}video(e){this._file(`video`,e),this.summary+=e.summary??`[视频: ${e.name}]`}button(){}}