import pkg from"icqq/package.json"with{type:"json"};import*as MessageConverter from"./message.js";function throwBool(e=`操作`){return t=>{if(t===!1)throw Error(`$${e}失败`)}}export default class ICQQtoPhilia{impl;constructor(e){this.impl=e}getVersion(){return{impl:{id:`QQ`,name:`ICQQ`,version:pkg.version},proto:this.impl.client.apk}}receiveEvent({event:e},t){return this.impl.event_handle.receive(e,t)}unreceiveEvent({event:e},t){return this.impl.event_handle.unreceive(e,t)}getSelfInfo(){return{id:String(this.impl.client.uin),name:this.impl.client.nickname,avatar:this.impl.client.pickUser(this.impl.client.uin).getAvatarUrl()}}async setSelfInfo({data:e}){e.name&&await this.impl.client.setNickname(e.name),e.avatar&&await this.impl.client.setAvatar(e.avatar)}_convertUserInfo(e){return{avatar:this.impl.client.pickUser(e.user_id).getAvatarUrl(),...e,id:String(e.user_id),name:e.nickname}}async getUserInfo({id:e}){let t=this.impl.client.pickFriend(+e);return this._convertUserInfo(t.info??await t.getSimpleInfo())}_convertGroupInfo(e){return{avatar:this.impl.client.pickGroup(e.group_id).getAvatarUrl(),...e,id:String(e.group_id),name:e.group_name,whole_mute:e.shutup_time_whole>0}}async getGroupInfo({id:e,refresh:t}){let n=await this.impl.client.pickGroup(+e),r=n.info;return(!r||t)&&(r=await n.renew()),this._convertGroupInfo(r)}_convertGroupMemberInfo(e){return{avatar:this.impl.client.pickMember(e.group_id,e.user_id).getAvatarUrl(),...e,id:String(e.user_id),name:e.nickname,mute_time:e.shutup_time}}async getGroupMemberInfo({id:e,uid:t,refresh:n}){let r=await this.impl.client.pickMember(+e,+t),i=r.info;return(!i||n)&&(i=await r.renew()),this._convertGroupMemberInfo(i)}async setInfo({scene:e,id:t,data:r}){switch(e){case`user`:{let e=this.impl.client.pickFriend(+t,!0);r.remark!==void 0&&await e.setRemark(r.remark);break}case`group`:{let e=this.impl.client.pickGroup(+t,!0);r.name!==void 0&&await e.setName(r.name).then(throwBool(`设置群名`)),r.avatar!==void 0&&await e.setAvatar(r.avatar),r.remark!==void 0&&await e.setRemark(r.remark),r.whole_mute!==void 0&&await e.muteAll(r.whole_mute).then(throwBool(`设置群全员禁言`));break}}}async setGroupMemberInfo({id:e,uid:t,data:n}){let r=this.impl.client.pickMember(+e,+t,!0);n.card!==void 0&&await r.setCard(n.card),n.title!==void 0&&await r.setTitle(n.title),n.role!==void 0&&await r.setAdmin(n.role===`admin`),n.mute_time!==void 0&&await r.mute(n.mute_time)}delUser({id:e,block:t}){return this.impl.client.pickFriend(+e).delete(t===!0).then(throwBool(`删除好友`))}async delGroup({id:e,dismiss:t}){if(!(!t&&(await this.getGroupMemberInfo({id:e,uid:(await this.getSelfInfo()).id})).role===`owner`))return this.impl.client.pickGroup(+e).quit().then(throwBool(`退出群`))}delGroupMember({id:e,uid:t,block:r}){return this.impl.client.pickMember(+e,+t).kick(void 0,r).then(throwBool(`删除群成员`))}async sendMsg({scene:e,id:n,data:r}){let i=await new MessageConverter.PhiliaToICQQ(this.impl,e,n,r).convert();if(!i.after.length){if(!i.summary)throw Error(`空消息`);return{id:``,time:Math.floor(Date.now()/1e3)}}let a=await(e===`user`?this.impl.client.pickUser(+n).sendMsg(i.after):this.impl.client.pickGroup(+n).sendMsg(i.after)),o={time:a.time??Math.floor(Date.now()/1e3),id:a.message_id,raw:a};return i.file_id&&(o.file_id=i.file_id),o}async sendMultiMsg({scene:e,id:n,data:r}){let i=[];for(let a of r){let r=await new MessageConverter.PhiliaToICQQ(this.impl,e,n,a.message).convert();if(!r.after.length)continue;i.push({user_id:Number(a.user?.id)||8e7,nickname:a.user?.name||`匿名消息`,message:r.after,time:a.time})}if(!i.length)return[{id:``,time:Math.floor(Date.now()/1e3)}];let a=await(e===`user`?this.impl.client.pickUser(+n).makeForwardMsg(i):this.impl.client.pickGroup(+n).makeForwardMsg(i)),o=await this.sendMsg({scene:e,id:n,data:{type:`platform`,mode:`include`,list:`ICQQ`,data:a}});return[o]}async _sendFile({scene:e,id:t,data:n}){let r;switch(n.data){case`id`:break;case`path`:case`binary`:case`url`:r=n[n.data];break}if(!r)throw Error(`获取文件错误`);let i=await(e===`user`?this.impl.client.pickFriend(+t).sendFile(r):(await this.impl.client.pickGroup(+t).sendFile(r)).fid);return i}async getMsg({id:e}){let t=await this.impl.client.getMsg(e);if(!t)throw Error(`获取消息失败`);return this.impl.event.Message(t)}delMsg({id:e}){return this.impl.client.deleteMsg(e).then(throwBool(`撤回消息`))}async sendMsgForward({scene:e,id:t,mid:n}){let r=await this.impl.client.getMsg(n);if(!r?.message)throw Error(`获取消息错误`);return this.sendMsg({scene:e,id:t,data:{type:`platform`,mode:`include`,list:`ICQQ`,data:r.message}})}getFile({id:e}){return{id:e}}async getChatHistory({type:e,id:t,count:n,newer:r}){let i=[];switch(e){case`message`:r||(i=await this.impl.client.getChatHistory(t,n));break;case`user`:i=await this.impl.client.pickUser(+t).getChatHistory(void 0,n);break;case`group`:i=await this.impl.client.pickGroup(+t).getChatHistory(void 0,n);break}return Promise.all(i.map(this.impl.event.Message.bind(this.impl.event)))}async getUserList({refresh:e}={}){return e&&await this.impl.client.reloadFriendList(),Array.from(this.impl.client.fl.keys()).map(e=>String(e))}async getUserArray({refresh:e}={}){return e&&await this.impl.client.reloadFriendList(),Array.from(this.impl.client.fl.values()).map(this._convertUserInfo.bind(this))}async getGroupList({refresh:e}={}){return e&&await this.impl.client.reloadGroupList(),Array.from(this.impl.client.gl.keys()).map(e=>String(e))}async getGroupArray({refresh:e}={}){return e&&await this.impl.client.reloadGroupList(),Array.from(this.impl.client.gl.values()).map(this._convertGroupInfo.bind(this))}async getGroupMemberList({id:e,refresh:t}){return Array.from((await this.impl.client.pickGroup(+e).getMemberMap(t)).keys()).map(e=>String(e))}async getGroupMemberArray({id:e,refresh:t}){return Array.from((await this.impl.client.pickGroup(+e).getMemberMap(t)).values()).map(this._convertGroupMemberInfo.bind(this))}async getRequestArray({scene:e,count:t}={}){let n=[];for(let r of await this.impl.client.getSystemMsg()){if(r.request_type===`friend`){if(e&&e!==`user_add`)continue;n.push(this.impl.event.FriendRequest(r))}else if(r.sub_type===`add`){if(e&&e!==`group_add`)continue;n.push(this.impl.event.GroupRequest(r))}else{if(e&&e!==`group_invite`)continue;n.push(this.impl.event.GroupRequest(r))}if(t&&n.length===t)break}return Promise.all(n)}async setRequest({id:e,result:t,reason:r}){if(e.startsWith(`friend|`))return this.impl.client.setFriendAddRequest(e.replace(`friend|`,``),t).then(throwBool(`处理好友请求`));if(e.startsWith(`group|`))return this.impl.client.setGroupAddRequest(e.replace(`group|`,``),t,r).then(throwBool(`处理群请求`))}uploadCacheFile(){throw Error(`暂不支持`)}clearCache(){}async getForwardMsg({id:e}){let t=await this.impl.client.getForwardMsg(e);return Promise.all(t.map(this.impl.event.ForwardMessage.bind(this.impl.event)))}sendPoke({scene:e,id:t,tid:r}){return(e===`user`?this.impl.client.pickFriend(+t).poke(+r===this.impl.client.uin):this.impl.client.pickMember(+t,+r).poke()).then(throwBool(`发送戳一戳`))}getGroupAnnounceList(){return[]}sendGroupAnnounce({id:e,content:t}){return this.impl.client.pickGroup(+e).announce(t).then(throwBool(`群公告`))}delGroupAnnounce(){}writeUni(e){return this.impl.client.writeUni(...e)}sendOidb(e){return this.impl.client.sendOidb(...e)}sendPacket(e){return this.impl.client.sendPacket(...e)}sendUni(e){return this.impl.client.sendUni(...e)}sendOidbSvcTrpcTcp(e){return this.impl.client.sendOidbSvcTrpcTcp(...e)}getRoamingStamp({refresh:e}={}){return this.impl.client.getRoamingStamp(e)}delRoamingStamp({id:e}){return this.impl.client.deleteStamp(e)}setUserClass({name:e,id:t}){return this.impl.client.pickFriend(+t).setClass(e)}addUserClass({name:e}){return this.impl.client.addClass(e)}delUserClass({name:e}){return this.impl.client.deleteClass(e)}renameUserClass({name:e,new_name:t}){return this.impl.client.renameClass(e,t)}getImageOCR({image:e}){return this.impl.client.imageOcr(e[e.data])}getSelfCookie({domain:e}={}){return e?this.impl.client.cookies[e]:Object.fromEntries(Object.entries(this.impl.client.cookies))}getSelfCSRFToken(){return this.impl.client.bkn}sendUserLike({id:e,times:t}){return this.impl.client.pickFriend(+e).thumbUp(t).then(throwBool(`资料卡点赞`))}addUserBack({id:e,seq:t,remark:r}){return this.impl.client.pickFriend(+e).addFriendBack(t,r).then(throwBool(`添加好友`))}async searchUserSameGroup({id:e}){let t=await this.impl.client.pickFriend(+e).searchSameGroup();return t.map(e=>this.impl.handle.getGroupInfo({id:String(e.Group_Id)}))}getGroupFSDf({id:e}){return this.impl.client.pickGroup(+e).fs.df()}getGroupFSStat({id:e,fid:t}){return this.impl.client.pickGroup(+e).fs.stat(t)}getGroupFSDir({id:e,pid:t,start:n,limit:r}){return this.impl.client.pickGroup(+e).fs.dir(t,n,r)}addGroupFSDir({id:e,name:t}){return this.impl.client.pickGroup(+e).fs.mkdir(t)}delGroupFSFile({id:e,fid:t}){return this.impl.client.pickGroup(+e).fs.rm(t)}renameGroupFSFile({id:e,fid:t,name:n}){return this.impl.client.pickGroup(+e).fs.rename(t,n)}moveGroupFSFile({id:e,fid:t,pid:n}){return this.impl.client.pickGroup(+e).fs.mv(t,n)}uploadGroupFSFile({id:e,file:t,pid:n,name:r}){return this.impl.client.pickGroup(+e).fs.upload(t,n,r)}forwardGroupFSFile({id:e,fid:t,pid:n,name:r}){return typeof t==`string`&&(t=this.getGroupFSStat({id:e,fid:t})),this.impl.client.pickGroup(+e).fs.forward(t,n,r)}getGroupFSFile({id:e,fid:t}){return this.impl.client.pickGroup(+e).fs.download(t)}async addGroupEssence({id:e,seq:t,rand:n}){if(!t){let r=await this.impl.client.getMsg(e);if(!r)throw Error(`获取消息失败`);t=r.seq,n=r.rand}await this.impl.client.pickGroup(+e).addEssence(t,n)}async delGroupEssence({id:e,seq:t,rand:n}){if(!t){let r=await this.impl.client.getMsg(e);if(!r)throw Error(`获取消息失败`);t=r.seq,n=r.rand}await this.impl.client.pickGroup(+e).removeEssence(t,n)}setReaded({id:e,seq:t,time:n}){return typeof t==`number`?this.impl.client.pickGroup(+e).markRead(t):n?this.impl.client.pickFriend(+e).markRead(n):this.impl.client.reportReaded(e)}setMessageRate({id:e,times:t}){return this.impl.client.pickGroup(+e).setMessageRateLimit(t).then(throwBool(`设置消息频率`))}setGroupJoinType({id:e,type:t,question:r,answer:i}){return this.impl.client.pickGroup(+e).setGroupJoinType(t,r,i).then(throwBool(`设置入群方式`))}getGroupAtAllRemainder({id:e}){return this.impl.client.pickGroup(+e).getAtAllRemainder()}sendGroupUserInvite({id:e,uid:t}){return this.impl.client.pickGroup(+e).invite(+t).then(throwBool(`邀请好友入群`))}sendGroupSign({id:e}){return this.impl.client.pickGroup(+e).sign()}async _getReactionType(e){let t=await this.impl.client.getMsg(e.id);if(!t)throw Error(`获取消息失败`);e.seq=t.seq,t.message_type===`private`?(e.type=`user`,e.id=String(t.sender.user_id)):(e.type=`group`,e.id=String(t.group_id))}async setReaction(e){if(e.type===`message`&&await this._getReactionType(e),e.type===`group`)return this.impl.client.pickGroup(+e.id).setReaction(e.seq,e.eid,e.etype)}async delReaction(e){if(e.type===`message`&&await this._getReactionType(e),e.type===`group`)return this.impl.client.pickGroup(+e.id).delReaction(e.seq,e.eid,e.etype)}}