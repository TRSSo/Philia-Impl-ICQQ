import*as inquirer from"@inquirer/prompts";import icqq from"icqq";import{makeLogger}from"philia/logger";import*as Common from"philia/project/project/common.js";import*as Philia from"philia/project/project/philia.js";import EventHandle from"philia/protocol/common/event.js";import{selectArray}from"philia/util/tui.js";import{API,Event}from"#convert";export class Project extends Common.Project{client;philia;handle;event;event_handle;constructor(e){super(e),this.client=new icqq.Client({data_dir:`Data/${e.uin}`,...e.config}),this.client.logger=makeLogger(`ICQQ`),this.event=new Event(this),this.handle=new API(this),this.philia=new Philia.Project(e.philia,this.handle),this.event_handle=new EventHandle(this.philia)}static async createConfig(e){let o={name:e,config:{},philia:await Philia.Project.createConfig(`App`),slider:`https://GT.928100.xyz/captcha/slider`};return await Project.editConfig(o),o}static edit_config_key=[[`platform`,`设备`,`number`],[`ver`,`版本`,`string`],[`sign_api_addr`,`签名服务器地址`,`string`],[`ignore_self`,`过滤自己的消息`,`boolean`],[`cache_group_member`,`缓存群成员列表`,`boolean`],[`resend`,`风控时分片发送`,`boolean`],[`reconn_interval`,`重新登录间隔`,`number`],[`ffmpeg_path`,`FFmpeg 路径`,`string`],[`ffprobe_path`,`FFprobe 路径`,`string`],[`auto_server`,`自动选择最优服务器`,`boolean`]];static async editConfig(s){for(;;){let c=await inquirer.select({message:`请选择要修改的配置项`,choices:[...selectArray([[`uin`,`QQ号`],[`passwd`,`密码`],...Project.edit_config_key,[`slider`,`滑动验证代理`]],[s.uin,`*`.repeat(s.passwd?.length),...Project.edit_config_key.map(e=>s.config[e[0]]===void 0?void 0:String(s.config[e[0]])),s.slider]),{value:`done`,name:`✅  完成`}]});switch(c){case`platform`:s.config.platform=await inquirer.select({message:`请选择登录设备`,choices:selectArray([[icqq.Platform.Android,`手机`],[icqq.Platform.aPad,`平板`],[icqq.Platform.Watch,`手表`],[icqq.Platform.iMac,`iMac`],[icqq.Platform.Tim,`TIM`],[icqq.Platform.Custom,`自定义`]])});break;case`uin`:s.uin=await inquirer.number({message:`请输入QQ号:`,required:!0,min:1e4,max:2**32-1});break;case`passwd`:s.passwd=await inquirer.password({message:`请输入密码:`});break;case`slider`:s.slider=await inquirer.input({message:`请输入滑动验证代理:`,default:String(s.slider),required:!0,validate(e){try{new URL(e)}catch{return`请输入正确的URL`}return!0}});break;case`done`:return;default:{let o=Project.edit_config_key.find(e=>e[0]===c)?.[2];if(o===`boolean`)s.config[c]=await inquirer.confirm({message:`请输入 ${c}:`,default:s.config[c]});else{let l=await(o===`string`?inquirer.input:inquirer.number)({message:`请输入 ${c}:`,default:s.config[c]});l===``||l===void 0?delete s.config[c]:s.config[c]=l}}}}}verifyConfig(){if(typeof this.config.uin!=`number`||this.config.uin<1e4||this.config.uin>=2**32)throw TypeError(`请输入正确的QQ号`);try{this.config.slider=new URL(this.config.slider),this.config.slider.searchParams.set(`key`,String(this.config.uin))}catch(e){throw TypeError(`滑动验证代理地址格式错误`,{cause:e})}}start(){return this.client.login(this.config.uin,this.config.passwd)}stop(){return Promise.allSettled([this.client.logout(),this.philia.stop()])}}